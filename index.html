<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Itinerary</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.snow.css">
    <link rel="stylesheet" href="https://cdn.quilljs.com/1.3.6/quill.bubble.css">  
    
    <style>
        * {
            border: 0;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --hue: 222;                               
            --trans-dur: 0.3s;
            --trans-timing: cubic-bezier(0.65,0,0.35,1);
            font-size: calc(16px + (24 - 16) * (100vw - 320px) / (2560 - 320));
        }
      
        .dark-theme {
            --bg: hsl(var(--hue), 0%, 0%);
            --fg: hsl(var(--hue), 10%, 90%);          
            --primary-color: hsl(var(--hue), 90%, 70%);
            --secondary-color: hsl(var(--hue), 0%, 50%, 0.2);          
        }
      
        .light-theme {
            --bg: hsl(var(--hue), 10%, 95%);
            --fg: hsl(var(--hue), 10%, 5%);
            --primary-color: hsl(var(--hue), 90%, 70%);
            --secondary-color: hsl(var(--hue), 10%, 85%);
        }

        html {
            background-color: var(--bg);
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            transition:
                background-color var(--trans-dur),
                color var(--trans-dur);
        }
      
        body {
            font: 1em/1.5 'Arial, Helvetica, sans-serif';
            color: var(--fg);
            height: 100vh;
            transition:
                background-color var(--trans-dur),
                color var(--trans-dur);
        }      
      

        a {
            color: var(--primary);
            transition: color var(--trans-dur);
        }

        h1 {
            font-size: 24px;
            text-align: center;
            padding: 2rem 0 0.5rem 0;
            color: var(--fg);
        }

        .menu-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 35px 0;
        }

        .menu-buttons button {
            width: 30px;
            height: 30px;
            border: 1px solid transparent;
            border-radius: 50%;
            background-color: transparent;
            color: var(--fg);
            cursor: pointer;
            font-size: 15px;
            transition:
                background-color calc(var(--trans-dur) / 2) linear,
                color var(--trans-dur);
            -webkit-tap-highlight-color: transparent;
        }

        .menu-buttons button:hover {
            background-color: hsl(var(--hue),10%,50%);
        }
      

        #calendar-container {
          display: none;
          text-align: center;
          margin: 0 20px;
          margin-bottom: 30px;
        }
      
        #calendar {
            display: table; /* デフォルトのテーブル表示 */
            margin: 2px auto; /* 中央揃え */
            text-align: center; /* テキスト中央揃え */
            border-spacing: 20px 5px;
            font-size: 16px;
        }

        #calendar th, #calendar td {
            padding: 0 5px; /* セル内の余白 */
        }

        #calendar th {
            font-weight: bold; /* 曜日ヘッダーを太字 */
            transition:
                background-color var(--trans-dur),
                color var(--trans-dur);
        }

        #calendar td {
            text-align: center; /* テキストを中央揃え */
            vertical-align: middle; /* 垂直方向の中央揃え */
            background-color: var(--bg); /* 背景色 */
            color: grey; /* テキスト色 */
            transition:
                background-color var(--trans-dur),
                color var(--trans-dur);          
        }
      
        #calendar td.today {
            border-radius: 30%;
            background-color: var(--fg) !important;
            color: var(--bg) !important;
            font-weight: bold !important;
            transition:
                background-color var(--trans-dur),
                color var(--trans-dur);          
        }

      

        #calendar td.highlight {
            border: 1px solid var(--fg); /* 枠線の色 */
            border-radius: 50%; /* 正円を保証 */
            background-color: var(--secondary-color); /* 背景色 */
            color: var(--fg); /* テキストの色 */
            text-align: center; /* テキストを中央揃え */
            align-items: center; /* 垂直方向の中央揃え */
            justify-content: center; /* 水平方向の中央揃え */
            cursor: pointer;
        }
      
        .timeline {
            background-color: transparent;
            margin: auto;
            padding: 0 1.5em;
            width: 100%;
            max-width: 36em;
            position: relative;
        }

        /* line */
        .timeline::before {
            content: '';
            position: absolute;
            top: var(--timeline-line-top, 0px); /* 高さを動的に設定 */
            margin-left: 46px; /* 横位置を固定 */
            width: 1px; /* 線の太さ */
            height: var(--timeline-line-height, 100%); /* 高さを動的に設定 */
            background: var(--fg);
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin: 20px 5px;
            position: relative;
        }

        .timeline-item .toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            height: 30px;
            width: 30px;
            border-radius: 50%;
            align-items: center;
            cursor: pointer;
            margin-right: 0px;
            transition: transform var(--trans-dur) var(--trans-timing);
            transform: rotate(0deg);
        }

        .timeline-item .toggle:hover {
            background-color: grey;

        }

        .timeline-item .toggle.collapsed {
            transform: rotate(-90deg);
        }

        .timeline-item .dot {
            width: 12px;
            height: 12px;
            background: var(--fg);
            border-radius: 50%;
            position: absolute;
            left: 35px;
            top: 15px;
            transform: translateY(-50%);
        }

        .timeline-item .content {
            margin-left: 35px;
            flex-grow: 1;
            max-width: calc(100% - 100px);
        }

        .timeline-item .content .date {
            height: 20px;
            font-size: 14px;
            color: var(--fg);
            margin-top: 5px;
            padding-top: 0px;
        }

        .timeline-item .content .title {
            font-size: 25px;
            color: var(--fg);
            margin-bottom: 5px;
        }



        .timeline-item .content .details {
            font-size: 14px;
            background: var(--secondary-color);
            color: var(--fg);
            border-radius: 10px;
            padding: 10px;
            max-height: 0; /* 初期の高さ */
            opacity: 0; /* 初期の透明度 */
            overflow: hidden; /* コンテンツのオーバーフローを隠す */
            transition:
                max-height 0.1s cubic-bezier(0.65,0,0.35,1),
                opacity 0.1s linear;
        }

        .timeline-item .content .details.expanded {
            max-height: 1000px; /* 適切な最大高さを設定 */
            opacity: 1; /* 完全に表示 */

        }

        .timeline-item .content .details .summary {
            margin-bottom: 10px;
        }
      
        .timeline-item .content .details .timeandItems {
            margin-top: 5px;
        }

        .timeline-item .content .details .description,
        .timeline-item .content .details .location,
        .timeline-item .content .details .address,
        .timeline-item .content .details .googleMap {
            margin-left: 45px; /* Description の余白 */
        }

        .timeline-item .content .details .googleMap,
        .timeline-item .content .details .additional-link {
            margin-top: 15px;
            display: inline-block; /* 必要に応じてアイコン位置調整 */
        }

        .additional-link {
            margin-left: 15px; /* 上部余白 */
        }



        input {
            display: block;
            margin: 20px auto;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-style: italic;
            
        }


        
        /* ▼▼▼ Quil-editor ▼▼▼ */
        .note {
            text-align: center;
            margin: 15px auto;
        }

        .btn {
            margin: 5px;
            width: 30px;
            height: 30px;
            border: 1px solid transparent;
            border-radius: 50%;
            background-color: transparent;
            color: var(--fg);
            cursor: pointer;
            font-size: 15px;
            transition:
                background-color calc(var(--trans-dur) / 2) linear,
                color var(--trans-dur);
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:hover {
            background-color: hsl(var(--hue),10%,50%);
        }

        .btn-group {
            text-align: center;
            gap: 0.375em;
            margin-bottom: .5em;
        }

        
        /*Quill*/
        #editor-container {
            margin: 0 auto;
            padding: 0 30px;
        }

        .ql-editor {
            font: 1em/1.5 'Arial, Helvetica, sans-serif';
            font-size: 16px;
            min-height: 170px;
            user-select: text;
        -webkit-user-select: text; /* Safari用の設定 */
        
        }

        .ql-editor ol,
        .ql-editor ul {
            padding-left: 0;
            margin-left: 0;
        }

        .ql-editor .ql-editor-1 {
            padding-left: 0px;
        } 

        .ql-toolbar {
            display: none;
            justify-content: center;
            margin-top: 10px;
            border-radius: 10px;
            width: 100%;
            background-color: transparent;
            border: 1px solid transparent !important;
        }

        .ql-toolbar.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .ql-container {
            margin: 0 auto;
            border-radius: 10px;
            max-width: calc(44em - 0px);
            background-color: hsl(var(--hue),10%,50%,0.2);
            border: 1px solid transparent !important;
        }

        .ql-toolbar button {
            color: hsl(var(--hue),10%,50%);              /* ボタンの文字色 */
            background-color: white;                   /* ボタンの背景色 */
            border: 1px solid #ccc;                    /* ボタンの枠線 */
        }

        .ql-toolbar button .ql-stroke,
        .ql-toolbar button .ql-fill {
            stroke: hsl(var(--hue),10%,50%);             /* アイコンの線の色（通常時） */
            fill: transparent;                           /* アイコンの塗りつぶし色（通常時） */
        }
        /* ▲▲▲ Quil-editor ▲▲▲ */

        #map {
            display: none; /* 初期状態は非表示 */
            position: fixed;
            top: 50%;
            left: 50%;
            width: 90%;
            height: 90%;
            transform: translate(-50%, -50%) scale(0); /* 非表示状態で縮小 */
            z-index: 9999;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            opacity: 0; /* 完全に透明 */
            transition: 
                transform var(--trans-dur) var(--trans-timing),
                opacity var(--trans-dur) var(--trans-timing);
        }

        #map.show {
            display: block;
            transform: translate(-50%, -50%) scale(1); /* 拡大して表示 */
            opacity: 1; /* 完全に表示 */
        }

        #map-container {
            width: 100%;
            height: 100%;
            border-radius: inherit;
            overflow: hidden;
        }

        #map-close {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: transparent; /* 背景を透明に */
            padding: 1px;
            border-radius: 50%; /* 円形に調整 */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* ボタンの幅 */
            height: 40px; /* ボタンの高さ */
        }

        #map-close img {
            width: 100%; /* 画像をボタン内にフィット */
            height: auto;
            display: block;
        }

        #map-close:hover {
            background: rgba(0, 0, 0, 0.1); /* ホバー時に軽く背景をつける */
        }
      
        #toggleWatchButton {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10000;
            background: transparent; /* 背景を透明に */
            padding: 1px;
            border-radius: 50%; /* 円形に調整 */
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* ボタンの幅 */
            height: 40px; /* ボタンの高さ */
        }

        #toggleWatchButton img {
            width: 100%; /* 画像をボタン内にフィット */
            height: auto;
            display: block;
        }

        #toggleWatchButton:hover {
            background: rgba(0, 0, 0, 0.1); /* ホバー時に軽く背景をつける */
        }  

        .blinking-marker {
            background-color: #004ACD99;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            animation: blink 1.3s infinite;
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
        }      

        #togglePositionButton {
            background: none;
            border: none; /* 枠線 */
            padding: 0px; /* 小さな内側の余白 */
            width: 30px; /* ボタンの幅 */
            height: 30px; /* ボタンの高さ */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px; /* アイコンのサイズ */
            cursor: pointer;
        }

        #togglePositionButton i {
            font-size: 14px; /* アイコンをさらに小さくする */
        }
      
      
        .zoom-control-container {
            position: fixed; /* 画面全体に対する配置を固定 */
            bottom: 20px;    /* 下からの距離 */
            right: 12px;     /* 初期設定は右下 */
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;   /* 他の要素より上に表示 */
            gap: 10px;       /* 子要素間の間隔 */
        }

        .zoom-control-container button {
            color: #333;
            opacity: 0.5;
            border-radius: 50%;
            background-color: none;
        }

        .zoom-control-container button:hover {
            transform: scale(1.1);
        }      
      


     
      
        footer {
            position: sticky;
            top: 100vh;
            top: 100dvh;
            font-size: 14px;
            font-family: var(--font-family);
            color: var(--fg);
            text-align: center;
            padding: 20px 0;
        }

        html {
            overflow-y: scroll;
        }
        
    </style>
</head>
<body>

    <h1>ITINERARY</h1>
    <div id="fileName" style="text-align: center; margin-bottom: 30px; color: grey; font-size: 14px;"></div>

    <div class="menu-buttons">
        <button id="fileUpload" onclick="fileUpload()"><i class="fa-solid fa-file-arrow-down"></i></button>       
        <button id="toggle-theme" onclick="toggleTheme()"><i class="fa fa-adjust"></i></button>
        <button id="mapping" onclick="mapping()"><i class="fa-solid fa-earth-americas"></i></button>
    </div>
    <input type="file" id="fileInput" accept=".xlsx, .xls, .xlsm" style="display: none;" />


    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
  
    <div class="timeline" id="timeline"></div>

    <div class="note" type="text">N O T E</div>

    <div class="btn-group">
        <button class="btn" id="save-btn" type="button"><i class="fa fa-save"></i></button>
        <button class="btn" id="undo-btn" type="button"><i class="fa-solid fa-rotate-left"></i></button>
        <button class="btn" id="redo-btn" type="button"><i class="fa-solid fa-rotate-right"></i></button>
        <button class="btn" id="delete-btn" type="button"><i class="fa-regular fa-trash-can"></i></button>
    </div>


    <div id="editor-container">
        <div id="editor"></div>
    </div>

    <div id="map">
        <button id="toggleWatchButton" onclick="toggleWatchingPosition()">
            <img src="https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD4D" 
                 alt="Start Watching" id="watchIcon" style="width: 30px; height: 30px;"/>
        </button>


        <div id="map-close" onclick="mapping()">
            <img src="https://img.icons8.com/?size=100&id=N6MjBhBaEOTN&format=png&color=000000"/>
        </div>
        <div id="map-container"></div>
    </div>

    <footer>
        Copyright © 2024 sakokeisuke Web Page. All rights reserved.
    </footer>



    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // 初期テーマ設定
        document.addEventListener('DOMContentLoaded', () => {
            const html = document.documentElement; // <html>要素を取得
            html.classList.add('dark-theme'); // 初期テーマをダークモードに設定
        });
      
      

        const quill = new Quill('#editor', {
            theme: 'snow',
            bounds: '#editor',
            modules: {
                toolbar: [
                    ['bold', 'italic'],      // Text styling
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],   // Lists
                    [{ 'indent': '-1' }, { 'indent': '+1' }],       // outdent/indent                  
                    ['link', 'image', 'video']                      // Insert link or image
                ]
            }
        });
      
        //          ['bold', 'italic', 'underline', 'strike'],      // Text styling
        //          [{ 'header': 1 }, { 'header': 2 }],             // Header 1 and Header 2
        //          [{ 'list': 'ordered'}, { 'list': 'bullet' }],   // Lists
        //          [{ 'color': [] }, { 'background': [] }],        // Text color and background color
        //          [{ 'align': [] }],                              // Text alignment
        //          [{ 'indent': '-1' }, { 'indent': '+1' }],       // outdent/indent                  
        //          ['link', 'image', 'video']                      // Insert link or image
 

        // エディターがフォーカスされたとき
        quill.root.addEventListener('focus', function() {
        document.querySelector('.ql-toolbar').style.display = 'flex';
        document.querySelector('.ql-toolbar').style.justifycontent = 'center';
        });

        // クリックした場所がツールバーやエディタ内でなければツールバーを非表示にする
        document.addEventListener('click', function(event) {
          const toolbar = document.querySelector('.ql-toolbar');
          const editor = document.querySelector('.ql-editor');

          // クリックした場所がツールバーやエディタ内でない場合、ツールバーを非表示にする
          if (!toolbar.contains(event.target) && !editor.contains(event.target)) {
            toolbar.style.display = 'none';
          } else {
            toolbar.style.display = 'flex';
          }
        });
      
        quill.getModule('toolbar').addHandler('link', function() {
            const value = prompt('Enter the link URL');
            if (value) {
                quill.format('link', value);  // リンクを挿入
            }
        });

        //Position of Popup
        quill.on('selection-change', (range) => {
            if (range) {
                const bounds = quill.getBounds(range);
                popup.style.top = `${bounds.top - 30}px`; // テキストの上に配置
                popup.style.left = `50%`; // 中央に配置
                popup.style.display = 'block'; // ポップアップを表示
            } else {
                popup.style.display = 'none'; // 選択が解除されたら非表示
            }
        });
      
      

        // 初期ロード時にローカルストレージからデータを復元
        window.addEventListener('load', function () {
            const savedContent = localStorage.getItem('editorContent');
            if (savedContent) {
                quill.setContents(JSON.parse(savedContent)); // ローカルストレージから復元
                console.log('Editor content restored:', JSON.parse(savedContent));
            } else {
                console.log('No data to restore.');
            }
        });

        // 保存処理
        document.getElementById('save-btn').addEventListener('click', function () {
            const content = quill.getContents(); // エディタの内容を取得
            localStorage.setItem('editorContent', JSON.stringify(content)); // ローカルストレージに保存
            alert('Editor content saved successfully!');
        });

        // アンドゥ処理
        document.getElementById('undo-btn').addEventListener('click', function () {
            quill.history.undo(); // エディタの元に戻す機能
            alert('Undo action performed!');
        });

        // リドゥ処理
        document.getElementById('redo-btn').addEventListener('click', function () {
            quill.history.redo(); // エディタのやり直し機能
            alert('Redo action performed!');
        });

        // 削除処理
        document.getElementById('delete-btn').addEventListener('click', function () {
            const confirmDelete = confirm('Are you sure you want to delete the content?');
            if (confirmDelete) {
                quill.setContents([]); // エディタの内容をクリア
                localStorage.removeItem('editorContent'); // ローカルストレージからも削除
                alert('Content deleted successfully!');
            }
        });   

      
      
      
      

        





        // ファイル選択ダイアログを表示
        function fileUpload() {
            document.getElementById('fileInput').click();
        }

      
        document.getElementById("fileInput").addEventListener("change", handleFile);

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheetName = "Timeline";
                const sheet = workbook.Sheets[sheetName];


                // C9 (中心座標) の取得
                const centerValue = sheet["C9"] ? sheet["C9"].v : null;
                if (centerValue) {
                    const [lat, lng] = centerValue.split(",").map(Number); // 緯度・経度を分割
                    mapCenter = [lat, lng]; // 中心座標を更新
                }

                // C10 (ズームスケール) の取得
                const zoomValue = sheet["C10"] ? parseInt(sheet["C10"].v, 10) : null;
                if (zoomValue) {
                    zoomScale = zoomValue; // ズームスケールを更新
                }



                // 開始日と終了日の取得
                const startDate = parseExcelDate(sheet["C3"].v);
                const endDate = parseExcelDate(sheet["C4"].v);

                // カレンダー生成
                generateCalendar(startDate, endDate);


                

            };
            reader.readAsArrayBuffer(file);
        }

        function parseExcelDate(value) {
            if (typeof value === "number") {
                return convertExcelDate(value);
            }
            return new Date(value);
        }

        function convertExcelDate(excelDate) {
            const baseDate = new Date(Date.UTC(1900, 0, 1)); // UTC基準
            const offset = excelDate - 2; // Excelのシリアル値補正
            return new Date(baseDate.getTime() + offset * 24 * 60 * 60 * 1000);
        }
        function generateCalendar(startDate, endDate) {
            const container = document.getElementById("calendar-container");
            const table = document.getElementById("calendar");

            // カレンダーを初期化
            table.innerHTML = "";

            // 曜日ヘッダーを作成
            const headerRow = document.createElement("tr");
            ["S", "M", "T", "W", "T", "F", "S"].forEach(day => {
                const th = document.createElement("th");
                th.textContent = day;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // 今日の日付を取得
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 開始日と終了日を基にカレンダー範囲を計算
            const start = new Date(startDate);
            start.setDate(start.getDate() - start.getDay() - 7);
            const end = new Date(endDate);
            end.setDate(end.getDate() + (6 - end.getDay()) + 7);

            let currentDate = new Date(start);
            while (currentDate <= end) {
                const row = document.createElement("tr");
                for (let i = 0; i < 7; i++) {
                    const cell = document.createElement("td");

                    // セルに日付を設定
                    const formattedDate = currentDate.toISOString().split("T")[0];
                    cell.textContent = currentDate.getDate();
                    cell.setAttribute("data-date", formattedDate);

                    // 今日の日付の処理
                    if (
                        currentDate.getFullYear() === today.getFullYear() &&
                        currentDate.getMonth() === today.getMonth() &&
                        currentDate.getDate() === today.getDate()
                    ) {
                        cell.classList.add("today");
                    }

                    // 開始日から終了日の範囲を強調
                    if (
                        currentDate >= startDate &&
                        currentDate <= endDate
                    ) {
                        cell.classList.add("highlight");

                        // クリックイベントを追加
                        cell.addEventListener("click", () => {
                            const timelineItem = document.querySelector(`.timeline-item[data-date="${formattedDate}"]`);
                            if (timelineItem) {
                                const details = timelineItem.querySelector(".details");
                                const toggle = timelineItem.querySelector(".toggle");

                                // タイムラインセクションの開閉
                                details.classList.toggle("expanded");
                                toggle.classList.toggle("collapsed");

                                // DOM変更後に正確な線の長さを計算
                                setTimeout(() => {
                                    adjustTimelineLineHeight(true);
                                }, 100);

                                // スムーズにスクロール
                                timelineItem.scrollIntoView({
                                    behavior: "smooth",
                                    block: "start",
                                });
                            }
                        });
                    }

                    row.appendChild(cell);
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                table.appendChild(row);
            }

            container.style.display = "block";
        }


        function scrollToTimelineSection(date) {
            const timelineSection = document.querySelector(`.timeline-item[data-date="${date}"]`);

            if (timelineSection) {
                const details = timelineSection.querySelector(".details");
                const toggle = timelineSection.querySelector(".toggle");

                // セクションを展開
                if (details && !details.classList.contains("expanded")) {
                    details.classList.add("expanded");
                    toggle.classList.remove("collapsed");
                }

                // スムーズにスクロール
                timelineSection.scrollIntoView({
                    behavior: "smooth",
                    block: "start",
                });
            } else {
                console.warn(`Timeline section for date ${date} not found.`);
            }
        }

        // Add Current Location
        let watchId = null; // 現在のwatchPositionのIDを保存
        let isWatching = false; // 現在監視中かどうかを保持
        let currentPositionMarker = null; // 現在位置を示すマーカー

        function toggleWatchingPosition() {
            const buttonIcon = document.getElementById("watchIcon");

            if (!isWatching) {
                // 現在位置の監視を開始
                if (navigator.geolocation) {
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;

                            // 現在位置を更新
                            updateCurrentPositionMarker(latitude, longitude);
                        },
                        (error) => {
                            console.error("Error watching position:", error);
                            alert("Error watching position:");
                        },
                        {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 10000
                        }
                    );

                    // アイコンを停止用に変更
                    buttonIcon.src = "https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD99"; // 赤色の停止アイコン
                    isWatching = true;
                } else {
                    alert("このブラウザでは現在位置取得機能がサポートされていません。");
                }
            } else {
                // 現在位置の監視を停止
                if (watchId !== null) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }

                // マーカーを地図から削除
                if (currentPositionMarker) {
                    window.myMap.removeLayer(currentPositionMarker);
                    currentPositionMarker = null; // マーカーの参照もクリア
                }

                // アイコンを開始用に戻す
                buttonIcon.src = "https://img.icons8.com/?size=100&id=ziC1TV1ikKi9&format=png&color=004ACD63"; // 黒色の開始アイコン
                isWatching = false;
            }
        }

        function updateCurrentPositionMarker(lat, lng) {
            // 既存のマーカーを削除
            if (currentPositionMarker) {
                window.myMap.removeLayer(currentPositionMarker);
            }

            // 新しいマーカーを作成
            const blinkingIcon = L.divIcon({
                className: 'blinking-marker',
            });

            currentPositionMarker = L.marker([lat, lng], { icon: blinkingIcon }).addTo(window.myMap);

            // 地図の中心を更新
            window.myMap.setView([lat, lng], window.myMap.getZoom());
        }








        // カテゴリごとのアイコン設定
        const categoryIcons = {
            "Airport": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=bPn4zx70nYmT&format=png&color=5E1E01A8",
                iconSize: [20, 20],
            }),
            "Hotel": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=qYund0sKw42x&format=png&color=000000",
                iconSize: [20, 20],
            }),
            "Restaurant": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=24801&format=png&color=86CBA4D1",
                iconSize: [20, 20],
            }),
            "Cafe and Bar": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=24801&format=png&color=469F9DD1",
                iconSize: [20, 20],
            }),          
            "Shop": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=bPn4zx70nYmT&format=png&color=0073FFB0",
                iconSize: [20, 20],
            }),
            "Destination": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=bPn4zx70nYmT&format=png&color=FE6F6F9E",
                iconSize: [20, 20],
            }),
            "Architecture": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=bPn4zx70nYmT&format=png&color=E0E9EB",
                iconSize: [20, 20],
            }),
          
          
            // for Bussiness
            "Primary": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=59830&format=png&color=4BAA8EA8",
                iconSize: [20, 20],
            }),
            "Condominium": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=24801&format=png&color=FF2E1754",
                iconSize: [20, 20],
            }),
            "Ecoba": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=59830&format=png&color=4BAA8EA8",
                iconSize: [20, 20],
            }),
            "Haseko": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=uRRFz0DH6uYw&format=png&color=000000",
                iconSize: [20, 20],
            }),          
          
            // デフォルトアイコン
            "default": L.icon({
                iconUrl: "https://img.icons8.com/?size=100&id=PKQ_ms_gTwMX&format=png&color=000000",
                iconSize: [20, 20],
            }),
        };

        // カテゴリごとのポリゴン色設定
        const categoryColors = {
            "Famous Zone": { fillColor: "rgba(0, 255, 0, 0.3)" },
          
            // For bussiness
            "Residential": { fillColor: "rgba(0, 255, 0, 0.3)" },
            "Commercial": { fillColor: "rgba(0, 0, 255, 0.3)" },
            "Industrial": { fillColor: "rgba(255, 0, 0, 0.3)" },
            "Area": { fillColor: 'gold' },
            "PJ Site": { fillColor: '#FF0062A8' },
            "default": { color: "gray", fillColor: "rgba(128, 128, 128, 0.3)" }
        };

        let markers = []; // 現在のマーカーを格納する配列
        let polygons = []; // 現在のポリゴンを格納する配列

        // マーカーとポリゴンをクリアする関数
        function clearMarkersAndPolygons() {
            markers.forEach(marker => {
                if (window.myMap.hasLayer(marker)) {
                    window.myMap.removeLayer(marker); // 地図からマーカーを削除
                }
            });
            polygons.forEach(polygon => {
                if (window.myMap.hasLayer(polygon)) {
                    window.myMap.removeLayer(polygon); // 地図からポリゴンを削除
                }
            });
            markers = []; // マーカー配列をリセット
            polygons = []; // ポリゴン配列をリセット
        }

        // マーカーとポリゴンを追加する関数
        function addMarkersAndPolygonsToMap() {
            if (!window.markerData) {
                console.error("No marker data available."); // エラーメッセージを出力
                return; // データがない場合は終了
            }

            // 既存のマーカーとポリゴンをクリア
            clearMarkersAndPolygons();

            // マーカーとポリゴンをデータから生成
            window.markerData.forEach(({ Coords, Title, Time, Items, Location, Category, Area }) => {
                // マーカーの処理
                if (Coords) {
                    const coordsArray = Coords.split(",");
                    const lat = parseFloat(coordsArray[0]); // 緯度
                    const lng = parseFloat(coordsArray[1]); // 経度

                    const title = Title || "No Title"; // タイトルがない場合はデフォルト値
                    const time = Time || "No Time"; // 時間がない場合はデフォルト値
                    const items = Items || "No Items"; // アイテムがない場合はデフォルト値
                    const location = Location || "No Location"; // 場所がない場合はデフォルト値
                    const category = Category || "default"; // カテゴリがない場合はデフォルト値

                    // カテゴリに応じたアイコンを取得
                    const icon = categoryIcons[category] || categoryIcons["default"];

                    // マーカーを作成
                    const marker = L.marker([lat, lng], { icon: icon });
                    marker.addTo(window.myMap); // 地図に追加

                    // マーカーにポップアップをバインド
                    const popupContent = `
                        <b style="margin-bottom: 0px; display: block;">${location}</b>
                        <br>${category}
                        <br>Category: ${category}
                    `;
                    marker.bindPopup(popupContent, { offset: [0, -5] });

                    // マーカーのクリックイベントを追加
                    marker.on("click", function (e) {
                        console.log("Marker clicked at:", e.latlng); // 確認用ログ
                        if (window.myMap) {
                            window.myMap.flyTo([e.latlng.lat, e.latlng.lng], window.myMap.getZoom(), {
                                animate: true,
                                duration: 1 // アニメーションの持続時間
                            });
                            marker.openPopup(); // ポップアップを開く
                        } else {
                            console.error("Map instance not found!");
                        }
                    });

                    markers.push(marker); // マーカーを配列に追加
                }

                // ポリゴンの処理
                if (Area) {
                    try {
                        // AreaがJSON形式であることを確認してパース
                        const polygonCoords = JSON.parse(Area);
                        const { color, fillColor } = categoryColors[Category] || categoryColors["default"];

                        // ポリゴンを作成
                        const polygon = L.polygon(polygonCoords, {
                            color: color,
                            fillColor: fillColor,
                            weight: 2 // ポリゴンの線の太さ
                        });
                        polygon.addTo(window.myMap); // 地図に追加

                        // ポリゴンにポップアップをバインド
                        polygon.bindPopup(`<b>${Category} Area</b>`, { offset: [0, -5] });

                        // ポリゴンのクリックイベントを追加
                        polygon.on("click", function (e) {
                            if (window.myMap) {
                                window.myMap.setView([e.latlng.lat, e.latlng.lng], window.myMap.getZoom(), {
                                    animate: true,
                                    duration: 1
                                });
                                polygon.openPopup(); // ポップアップを開く
                            }
                        });

                        polygons.push(polygon); // ポリゴンを配列に追加
                    } catch (error) {
                        console.error("Invalid Area format:", Area, error); // エラーメッセージを出力
                    }
                }
            });
        }

        // ファイルが読み込まれたときにマーカーとポリゴンを追加
        document.getElementById("fileInput").addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) {
                console.error("No file selected."); // ファイルが選択されていない場合
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });

                const sheet = workbook.Sheets["Timeline"];
                const sheetData = XLSX.utils.sheet_to_json(sheet);

                window.markerData = sheetData;

                if (window.myMap) {
                    addMarkersAndPolygonsToMap();
                }
            };

            reader.readAsArrayBuffer(file); // ファイルをArrayBufferとして読み込む
        });
                

        let mapCenter = [21.03966820428092, 105.86461819490408]; // デフォルトの中心
        let zoomScale = 12; // デフォルトのズームスケール

        // 地図を初期化する `mapping` 関数内で、マーカーとポリゴンを追加
        function mapping() {
            const mapContainer = document.getElementById("map");

            if (mapContainer.classList.contains("show")) {
                mapContainer.classList.remove("show");
                setTimeout(() => (mapContainer.style.display = "none"), 300);
                return;
            }

            mapContainer.style.display = "block";
            setTimeout(() => {
                mapContainer.classList.add("show");
                if (window.myMap) {
                    window.myMap.invalidateSize(); // サイズ再計算
                }
            }, 10);

            if (window.myMap) {
                window.myMap.setView(mapCenter, zoomScale);
                addMarkersAndPolygonsToMap();
                return;
            }

            const mapTilerApiKey = "Sv80uSRLZxFEwRiW17Cg";

            window.myMap = L.map("map-container", { zoomControl: false }).setView(mapCenter, zoomScale);

            window.myMap.invalidateSize();

            L.tileLayer(`https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=${mapTilerApiKey}`, {
                attribution: '&copy; MapTiler &copy; OpenStreetMap contributors',
                maxZoom: 18,
                minZoom: 1,
                updateWhenIdle: true,
                keepBuffer: 10
            }).addTo(window.myMap);

            addMarkersAndPolygonsToMap();



            // カスタムズームボタンを右下に配置
            let isBottomRight = true;

            const zoomControlContainer = L.control({ position: 'bottomright' });
            zoomControlContainer.onAdd = function () {
                const div = L.DomUtil.create('div', 'zoom-control-container');
                div.innerHTML = `
                    <button id="togglePositionButton" style="margin-bottom: 10px;">
                        <i class="fa-solid fa-angles-left"></i>
                    </button>
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <button id="zoomInIcon" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                            <i class="fa-solid fa-circle-plus"></i>
                        </button>
                        <button id="zoomOutIcon" style="background: none; border: none; cursor: pointer; font-size: 24px;">
                            <i class="fa-solid fa-circle-minus"></i>
                        </button>
                    </div>
                `;

                // 位置切り替えボタンの動作
                div.querySelector('#togglePositionButton').addEventListener('click', () => {
                    const container = document.querySelector('.zoom-control-container');
                    const toggleIcon = document.querySelector('#togglePositionButton i');

                    // 確実に画面下に配置
                    container.style.position = 'fixed';
                    container.style.bottom = '20px';
                    if (isBottomRight) {
                        container.style.left = '25px';
                        container.style.right = 'auto';
                        toggleIcon.className = 'fa-solid fa-angles-right';
                    } else {
                        container.style.right = '12px';
                        container.style.left = 'auto';
                        toggleIcon.className = 'fa-solid fa-angles-left';
                    }
                    isBottomRight = !isBottomRight;
                });

                return div;
            };

            zoomControlContainer.addTo(window.myMap);

            // ズームインイベント（スムーズ）
            document.getElementById('zoomInIcon').addEventListener('click', function () {
                window.myMap.flyTo(window.myMap.getCenter(), window.myMap.getZoom() + 1, { animate: true, duration: 0.7 });
            });

            // ズームアウトイベント（スムーズ）
            document.getElementById('zoomOutIcon').addEventListener('click', function () {
                window.myMap.flyTo(window.myMap.getCenter(), window.myMap.getZoom() - 1, { animate: true, duration: 0.7 });
            });

            // ダブルクリックズームを無効化
            window.myMap.doubleClickZoom.disable();

            // ダブルクリックされた場所を地図の中心にスムーズに移動
            window.myMap.on('dblclick', function (e) {
                const latlng = e.latlng; // ダブルクリックされた位置の緯度経度

                // アニメーション付きで移動
                window.myMap.flyTo(latlng, window.myMap.getZoom(), {
                    animate: true,
                    duration: 0.7 // アニメーションの持続時間（秒）
                });
            });
        }


    

      
        function adjustTimelineLineHeight() {
            const timeline = document.querySelector('.timeline');
            const dots = document.querySelectorAll('.timeline-item .dot');

            if (!timeline || dots.length === 0) return;

            const firstDot = dots[0];
            const lastDot = dots[dots.length - 1];

            // タイムライン全体と各dotの位置を取得
            const timelineRect = timeline.getBoundingClientRect();
            const firstDotRect = firstDot.getBoundingClientRect();
            const lastDotRect = lastDot.getBoundingClientRect();

            // 線の開始位置と長さを計算
            const lineTop = firstDotRect.top - timelineRect.top + firstDotRect.height / 2;
            const lineHeight = lastDotRect.top - firstDotRect.top;

            // CSSカスタムプロパティを設定
            timeline.style.setProperty('--timeline-line-top', `${lineTop}px`);
            timeline.style.setProperty('--timeline-line-height', `${lineHeight}px`);
        }

        document.addEventListener('click', (event) => {
            const toggle = event.target.closest('.timeline-item .toggle');
            if (toggle) {
                const timelineItem = toggle.closest('.timeline-item');
                const details = timelineItem.querySelector('.details');

                if (!details) return;

                // 即時の高さ調整
                adjustTimelineLineHeight();

                // アニメーションの途中で高さを更新
                requestAnimationFrame(() => {
                    if (getComputedStyle(details).maxHeight !== '0px') {
                        adjustTimelineLineHeight();
                    }
                });

                // アニメーション終了時の正確な調整
                details.addEventListener('transitionend', adjustTimelineLineHeight, { once: true });
            }
        });

        // 初期ロードとリサイズ時の高さ調整
        document.addEventListener('DOMContentLoaded', adjustTimelineLineHeight);
        window.addEventListener('resize', adjustTimelineLineHeight);

      

        // ファイル読み込み後に呼び出す関数
        function onFileLoaded() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;

            // タイムラインを構築するロジックが完了した後に再計算
            setTimeout(() => {
                adjustTimelineLineHeight();
            }, 0);
        }

        // ページロード時とリサイズ時に適用
        window.addEventListener('load', adjustTimelineLineHeight);
        window.addEventListener('resize', adjustTimelineLineHeight);

        // トグルクリック時のイベント処理に再計算を追加
        document.addEventListener('click', (event) => {
            if (event.target.closest('.timeline-item .toggle')) {
                // CSS変数からアニメーション時間を取得
                const transitionDuration = parseFloat(
                    getComputedStyle(document.documentElement).getPropertyValue('--trans-dur')
                ) * 1000;

                setTimeout(adjustTimelineLineHeight, transitionDuration);
            }
        });

      

        // シリアル値を日付に変換する関数
        function convertExcelDate(excelDate) {
            const baseDate = new Date(Date.UTC(1900, 0, 1)); // UTC基準 // Excelの基準日 (1900-01-01)
            const offset = excelDate - 2; // Excelのシリアル値は1から始まる
            return new Date(baseDate.getTime() + offset * 24 * 60 * 60 * 1000);
        }

        // 日付をフォーマットする関数
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                weekday: 'short', // 曜日 (例: Sat)
                year: 'numeric',  // 年 (例: 2024)
                month: 'short',   // 月 (例: Nov)
                day: '2-digit'    // 日 (例: 02)
            });
        }

        // 時間をフォーマットする関数
        function formatTime(excelTime) {
            const totalSeconds = Math.round(excelTime * 24 * 60 * 60); // Excelのシリアル値を秒に変換
            const hours = Math.floor(totalSeconds / 3600) % 24; // 時間を計算
            const minutes = Math.floor(totalSeconds / 60) % 60; // 分を計算
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`; // "00:00"形式で返す
        }

        function isValidCoords(coords) {
            if (!coords || typeof coords !== 'string') return false;

            const parts = coords.split(',').map(Number);
            if (parts.length !== 2) return false;

            const [lat, lng] = parts;
            return (
                !isNaN(lat) && !isNaN(lng) &&
                lat >= -90 && lat <= 90 &&
                lng >= -180 && lng <= 180
            );
        }        

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileNameElement = document.getElementById('fileName'); // ファイル名表示用の要素
                fileNameElement.textContent = `Selected file: ${file.name}`; // ファイル名を設定
            }          
          
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // "Timeline"という名前のシートを取得
                const sheetName = 'Timeline';
                const sheet = workbook.Sheets[sheetName];

                // Convert sheet data to JSON
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                // Group data by Date
                const groupedData = jsonData.reduce((acc, item) => {
                    const date = item['Date'];
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(item);
                    return acc;
                }, {});

                // Display grouped timeline
                const timeline = document.getElementById('timeline');
                timeline.innerHTML = ''; // Clear existing data

                Object.keys(groupedData).forEach(date => {
                    const groupDiv = document.createElement('div');
                    groupDiv.classList.add('timeline-item');
                    
                    // タイムラインセクションに data-date 属性を追加
                    const dateObject = isNaN(date) ? new Date(date) : convertExcelDate(date);
                    const formattedDate = dateObject.toISOString().split("T")[0]; // ISO形式の日付
                    groupDiv.setAttribute('data-date', formattedDate);

                    const toggle = document.createElement('div');
                    toggle.classList.add('toggle', 'collapsed'); // Initially collapsed
                    toggle.innerHTML = '<i class="fas fa-solid fa-caret-down"></i>';
                    toggle.addEventListener('click', () => {
                        details.classList.toggle('expanded');
                        toggle.classList.toggle('collapsed');

                        // 線の長さを調整
                        adjustTimelineLineHeight();
                    });
                    groupDiv.appendChild(toggle);

                    const dot = document.createElement('div');
                    dot.classList.add('dot');
                    groupDiv.appendChild(dot);

                    const content = document.createElement('div');
                    content.classList.add('content');

                    const dateElement = document.createElement('div');
                    dateElement.classList.add('date');

                    // 日付がシリアル値の場合に変換
                    dateElement.textContent = formatDate(dateObject); // フォーマット後の日付を設定
                    content.appendChild(dateElement);

                    const title = document.createElement('div');
                    title.classList.add('title');
                    title.textContent = groupedData[date][0]['Title'] || 'No Title';
                    content.appendChild(title);

                    const details = document.createElement('div');
                    details.classList.add('details'); // Initially hidden

                    groupedData[date].forEach(item => {
                        const timeValue = item['Time'];
                        const timeFormatted = isNaN(timeValue) ? timeValue : formatTime(timeValue);
                        const div = document.createElement('div');
                        div.innerHTML = `
                            ${item['Summary'] ? `<p class="summary">${item['Summary']}</p>` : ''}
                            ${timeValue ? `<p class="timeandItems">${timeFormatted} - ${item['Items'] || ''}</p>` : ''}
                            ${item['Description'] ? `<p class="description">${item['Description']}</p>` : ''}
                            ${item['Location'] 
                                ? `<p class="location">@ ${item['Coords'] && isValidCoords(item['Coords']) 
                                    ? `<a href="#" class="location-link" data-coords="${item['Coords']}">${item['Location']}</a>` 
                                    : item['Location']}</p>` 
                                : ''}
                            ${item['Address'] ? `<p class="address">${item['Address']}</p>` : ''}                                
                            ${item['Google Map'] ? `<a class="googleMap" href="${item['Google Map']}" target="_blank">
                                                        <img src="https://img.icons8.com/?size=100&id=2m4kkop8aUO5&format=png&color=000000" 
                                                        alt="Google Map Icon" style="width: 20px; height: 20px;">
                                                    </a>` : ''}
                            ${item['Link1'] ? `<a class="additional-link" href="${item['Link1']}" target="_blank">
                                                        <img src="https://img.icons8.com/?size=100&id=OVMSsCK0bAsj&format=png&color=000000" 
                                                        alt="Link1 icon" style="width: 20px; height: 20px;">
                                                    </a>` : ''}
                            ${item['Link2'] ? `<a class="additional-link" href="${item['Link2']}" target="_blank">
                                                        <img src="https://img.icons8.com/?size=100&id=OVMSsCK0bAsj&format=png&color=000000" 
                                                        alt="Link2 icon" style="width: 20px; height: 20px;">
                                                    </a>` : ''}
                            ${item['Link3'] ? `<a class="additional-link" href="${item['Link3']}" target="_blank">
                                                        <img src="https://img.icons8.com/?size=100&id=OVMSsCK0bAsj&format=png&color=000000" 
                                                        alt="Link3 icon" style="width: 20px; height: 20px;">
                                                    </a>` : ''}
                        `;
                        details.appendChild(div);
                    });

                    content.appendChild(details);
                    groupDiv.appendChild(content);
                    timeline.appendChild(groupDiv);
                });
                // タイムラインが構築された後に高さを再計算
                onFileLoaded();                              
            };
            reader.readAsArrayBuffer(file);
        });



        // テーマ切り替え関数
        const toggleTheme = () => {
            const html = document.documentElement; // <html>要素を取得
            const isDarkTheme = html.classList.contains('dark-theme');
            html.classList.toggle('dark-theme', !isDarkTheme);
            html.classList.toggle('light-theme', isDarkTheme);
        };

        // ボタンにイベントを設定
        document.getElementById('toggle-theme').addEventListener('click', (event) => {
            event.stopPropagation(); // 他のクリックイベントに影響を与えない
            document.body.classList.toggle('dark-theme');
            document.body.classList.toggle('light-theme');
        });



        
        document.getElementById("timeline").addEventListener("click", (event) => {
            const link = event.target.closest('.location-link'); // クリックされた要素が`.location-link`か確認
            if (!link) return; // クリックされた場所がリンクでない場合は終了

            event.stopPropagation(); // イベントの伝播を停止

            const coords = link.getAttribute('data-coords');
            if (coords) {
                const [lat, lng] = coords.split(',').map(Number);

                // 地図が閉じている場合は開く
                const mapContainer = document.getElementById("map");
                if (!mapContainer.classList.contains("show")) {
                    mapping(); // 地図を開く
                }

                // 地図のサイズを再計算（必須）
                setTimeout(() => {
                    if (window.myMap) {
                        window.myMap.invalidateSize(); // サイズを再計算

                        // 地図の中心を移動
                        window.myMap.flyTo([lat, lng], 14, {
                            animate: true,
                            duration: 1.0, // アニメーションの持続時間を2秒に設定
                            easeLinearity: 0.3, // 滑らかさを調整
                        });

                        // マーカーのポップアップを探して開く
                        let markerFound = false;
                        window.myMap.eachLayer((layer) => {
                            if (layer instanceof L.Marker && layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                                layer.openPopup(); // ポップアップを開く
                                markerFound = true;
                            }
                        });

                        // マーカーが見つからなかった場合
                        if (!markerFound) {
                            console.warn(`No marker found at coordinates: ${lat}, ${lng}`);
                        }
                    } else {
                        console.error("Map instance is not initialized.");
                    }
                }, 500); // 地図を開いてから500ms待つ（アニメーションに合わせる）
            } else {
                console.warn("No coordinates found in the clicked link.");
            }
        });     
                
        // Locationクリックイベントの委譲を設定
        details.addEventListener('click', (event) => {
            const link = event.target.closest('.location-link'); // クリックされた場所がリンクか確認
            if (!link) return;

            event.stopPropagation(); // イベントの伝播を停止            

            const coords = link.getAttribute('data-coords');
            if (coords) {
                const [lat, lng] = coords.split(',').map(Number);

                // 地図を開いて該当位置に移動
                mapping(); // 地図を開く（既存の関数を使用）
                window.myMap.setView([lat, lng], 14);

                // マーカーのポップアップを開く
                window.myMap.eachLayer(layer => {
                    if (layer instanceof L.Marker && layer.getLatLng().lat === lat && layer.getLatLng().lng === lng) {
                        layer.openPopup();
                    }
                });
            }
        });      
      
      

 

        
        function handleOrientationChange() {
			if (window.matchmedia("(orientation: portait)").matches) {
				document.body.style.width = "100%";
			} else if (window.matchmedia("(orientation: landscape)").matches) {
				document.body.style.width = "100vw";
			}
		}


		window.addEventListener("orientationchange", handleOrientationChange);
		window.addEventListener("resize", handleOrientationChange);
		handleOrientationChange();



    </script>
</body>
</html>
